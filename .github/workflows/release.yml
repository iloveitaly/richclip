name: Release

on:
  push:
    branches:
      - master
  # Allow manual triggering for testing
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: simple

  build-and-release:
    runs-on: macos-latest
    needs: [release-please]
    if: needs.release-please.outputs.release_created
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Tests
        run: swift test

      - name: Build Universal Binary
        # Builds a fat binary containing both arm64 (Apple Silicon) and x86_64 (Intel) slices
        run: swift build -c release --arch arm64 --arch x86_64

      - name: Zip Binary
        run: zip -j richclip.zip .build/apple/Products/Release/richclip

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: richclip.zip
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          # We don't want to overwrite the changelog generated by release-please
          generate_release_notes: false

      # Uncomment and configure this block if you want to automatically update a Homebrew tap
      # - name: Update Homebrew formula
      #   uses: dawidd6/action-homebrew-bump-formula@v4
      #   with:
      #     # A PAT is required to push to a different repository (your tap)
      #     token: ${{ secrets.HOMEBREW_BUMP_TOKEN }}
      #     # Replace with your actual tap repository (e.g., username/homebrew-tap)
      #     tap: YOUR_GITHUB_USERNAME/homebrew-tap
      #     formula: richclip
      #     tag: ${{ needs.release-please.outputs.tag_name }}
      #     revision: ${{ github.sha }}
      #     force: false
